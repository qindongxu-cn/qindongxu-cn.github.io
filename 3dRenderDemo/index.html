<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Permissions-Policy" content="unload=*" />
  <title>模型渲染</title>
  <!-- importmap 用于映射 "three" 模块到本地文件 -->
  <script type="importmap">
      {
        "imports": {
          "three": "./libs/three.module.js",
          "three/addons/": "./libs/",
          "three/examples/jsm/": "./libs/"
        }
      }
    </script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    canvas {
      display: block;
    }

    /* 控制面板样式 */
    #controlPanel {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      min-width: 250px;
      z-index: 1000;
    }

    #controlPanel h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 18px;
    }

    .control-item {
      margin-bottom: 15px;
    }

    .control-item label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-size: 14px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #2196f3;
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }

    .speed-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .speed-slider {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .speed-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #2196f3;
      cursor: pointer;
    }

    .speed-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #2196f3;
      cursor: pointer;
      border: none;
    }

    .speed-value {
      min-width: 50px;
      text-align: right;
      color: #333;
      font-weight: bold;
    }
  </style>
  <!-- 使用 esm.sh CDN，自动处理模块依赖，无需 importmap -->
</head>
<body>
  <!-- 控制面板 -->
  <div id="controlPanel">
    <h3>动画控制</h3>

    <div class="control-item">
      <label>
        <span>启用旋转动画</span>
        <label class="switch">
          <input type="checkbox" id="animationToggle" checked />
          <span class="slider"></span>
        </label>
      </label>
    </div>

    <div class="control-item">
      <label>旋转速度</label>
      <div class="speed-control">
        <input type="range" id="speedSlider" class="speed-slider" min="0" max="180" step="5" value="5" />
        <span class="speed-value" id="speedValue">5</span>
      </div>
    </div>

    <div class="control-item">
      <label>镜头距离</label>
      <div class="speed-control">
        <input type="range" id="zoomSlider" class="speed-slider" min="0.5" max="3.0" step="0.1" value="0.5" />
        <span class="speed-value" id="zoomValue">0.5</span>
      </div>
    </div>

    <div class="control-item">
      <label>页面加载总耗时</label>
      <div style="color: #555; font-size: 14px">
        <div id="totalLoadTime" style="font-weight: bold; color: #9c27b0; font-size: 16px">
          计算中...
        </div>
      </div>
    </div>

    <div class="control-item">
      <label>模型加载状态</label>
      <div style="color: #555; font-size: 14px">
        <div id="loadStatus">准备加载...</div>
        <div>模型加载耗时</div>
        <div id="loadTime" style="margin-top: 5px; font-weight: bold; color: #2196f3">
          --
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // 记录页面加载开始时间（从脚本执行开始）
    const pageLoadStartTime = performance.now();
    const totalLoadTimeElement = document.getElementById("totalLoadTime");

    // 使用 esm.sh CDN，它会自动处理 "three" 模块的解析
    // import * as THREE from "https://esm.sh/three@0.165";
    // import { GLTFLoader } from "https://esm.sh/three@0.165/examples/jsm/loaders/GLTFLoader.js";
    // import { OrbitControls } from "https://esm.sh/three@0.165/examples/jsm/controls/OrbitControls.js";
    import * as THREE from "./libs/three.module.js";
    import { GLTFLoader } from "./libs/GLTFLoader.js";
    import { OrbitControls } from "./libs/OrbitControls.js";

    // 场景
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb); // 天蓝色背景

    /**-----------------------------------几何对象---------------*/
    //创建一个长方体几何对象Geometry
    // const geometry = new THREE.BoxGeometry(100, 100, 100);
    //创建一个材质对象Material
    // const material = new THREE.MeshBasicMaterial({
    // color: 0xff0000, //0xff0000设置材质颜色为红色
    // });
    // const mesh = new THREE.Mesh(geometry, material); //网格模型对象Mesh
    //设置网格模型在三维空间中的位置坐标，默认是坐标原点
    // mesh.position.set(0, 10, 0);
    // scene.add(mesh); //网格模型添加到场景中
    /**-----------------------------------几何对象---------------*/

    // 相机
    const camera = new THREE.PerspectiveCamera(
      60,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(2, 2, 3);

    // 渲染器
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // 控制器
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    // 灯光 - 四个方向 + 环境光
    // 前方灯光（正Z方向）
    const lightFront = new THREE.DirectionalLight(0xffffff, 0.8);
    lightFront.position.set(0, 2, 5);
    lightFront.castShadow = true;
    scene.add(lightFront);

    // 后方灯光（负Z方向）
    const lightBack = new THREE.DirectionalLight(0xffffff, 0.6);
    lightBack.position.set(0, 2, -5);
    lightBack.castShadow = true;
    scene.add(lightBack);

    // 左侧灯光（负X方向）
    const lightLeft = new THREE.DirectionalLight(0xffffff, 0.7);
    lightLeft.position.set(-5, 2, 0);
    lightLeft.castShadow = true;
    scene.add(lightLeft);

    // 右侧灯光（正X方向）
    const lightRight = new THREE.DirectionalLight(0xffffff, 0.7);
    lightRight.position.set(5, 2, 0);
    lightRight.castShadow = true;
    scene.add(lightRight);

    // 环境光（提供基础照明）
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambientLight);

    // 添加辅助网格（可选）
    // const gridHelper = new THREE.GridHelper(10, 10);
    // scene.add(gridHelper);

    // 保存模型引用，用于自动旋转
    let model = null;
    let modelSize = null; // 保存模型尺寸信息

    // 旋转控制参数
    let rotationSpeed = 5; // 旋转速度（度/秒），可以通过控制面板调整，默认5度/秒
    let rotationAngle = 0; // 当前旋转角度（度）
    let isAnimationEnabled = true; // 动画开关状态
    let zoomFactor = 0.5; // 缩放因子，可以通过控制面板调整

    // 加载时间记录
    let loadStartTime = null;
    const loadStatusElement = document.getElementById("loadStatus");
    const loadTimeElement = document.getElementById("loadTime");

    // 加载 gltf
    const loader = new GLTFLoader();

    // 记录开始加载时间
    loadStartTime = performance.now();
    loadStatusElement.textContent = "正在加载...";
    loadTimeElement.textContent = "--";

    loader.load(
      "./ZTZ99A.glb",
      (gltf) => {
        // 计算加载耗时
        const loadEndTime = performance.now();
        const loadDuration = loadEndTime - loadStartTime;

        scene.add(gltf.scene);
        model = gltf.scene; // 保存模型引用

        // 计算模型边界并调整相机位置
        const box = new THREE.Box3().setFromObject(gltf.scene);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());

        // 将模型移动到场景中心
        gltf.scene.position.x = -center.x;
        gltf.scene.position.y = -center.y;
        gltf.scene.position.z = -center.z;

        // 保存模型尺寸信息，用于缩放控制
        modelSize = {
          maxDim: Math.max(size.x, size.y, size.z),
          center: center,
        };

        // 调整相机位置以适应模型
        updateCameraPosition();

        // 计算页面加载总时长（从页面开始加载到模型渲染完成）
        const pageLoadEndTime = performance.now();
        const totalLoadDuration = pageLoadEndTime - pageLoadStartTime;

        // 更新加载状态显示
        loadStatusElement.textContent = "加载成功";
        loadStatusElement.style.color = "#4caf50";
        loadTimeElement.textContent = `${loadDuration.toFixed(2)} ms`;
        loadTimeElement.style.color = "#4caf50";

        // 更新页面加载总时长显示
        totalLoadTimeElement.textContent = `${totalLoadDuration.toFixed(
          2
        )} ms`;
        totalLoadTimeElement.style.color = "#4caf50";

        console.log("模型加载成功！", {
          center,
          size,
          maxDim: modelSize.maxDim,
        });
        console.log("模型加载耗时:", loadDuration.toFixed(2), "ms");
        console.log("页面加载总时长:", totalLoadDuration.toFixed(2), "ms");
        console.log("模型对象:", model);
        console.log("动画已启用:", isAnimationEnabled);
        console.log("当前旋转速度:", rotationSpeed, "度/秒");
      },
      (progress) => {
        const percent = ((progress.loaded / progress.total) * 100).toFixed(2);
        const elapsedTime = performance.now() - loadStartTime;
        const totalElapsedTime = performance.now() - pageLoadStartTime;
        loadStatusElement.textContent = `加载中... ${percent}%`;
        loadTimeElement.textContent = `已用时: ${elapsedTime.toFixed(0)} ms`;
        loadTimeElement.style.color = "#ff9800";
        // 更新页面加载总时长（实时）
        totalLoadTimeElement.textContent = `${totalElapsedTime.toFixed(
          0
        )} ms`;
        totalLoadTimeElement.style.color = "#ff9800";
        console.log(`加载进度: ${percent}%`);
      },
      (e) => {
        const loadEndTime = performance.now();
        const loadDuration = loadEndTime - loadStartTime;
        const totalLoadDuration = loadEndTime - pageLoadStartTime;
        loadStatusElement.textContent = "加载失败";
        loadStatusElement.style.color = "#f44336";
        loadTimeElement.textContent = `失败于: ${loadDuration.toFixed(2)} ms`;
        loadTimeElement.style.color = "#f44336";
        // 更新页面加载总时长（失败时）
        totalLoadTimeElement.textContent = `${totalLoadDuration.toFixed(
          2
        )} ms`;
        totalLoadTimeElement.style.color = "#f44336";
        console.error("加载失败:", e);
        console.log("尝试加载 .glb 文件失败，请检查文件路径和格式");
        console.log("页面加载总时长:", totalLoadDuration.toFixed(2), "ms");
      }
    );

    // 更新相机位置的函数
    function updateCameraPosition() {
      if (modelSize) {
        const distance = modelSize.maxDim * zoomFactor;
        camera.position.set(distance, distance * 0.6, distance);
        camera.lookAt(0, 0, 0);
        controls.target.set(0, 0, 0);
        controls.update();
      }
    }

    // 自适应窗口变化
    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // 动画循环 - 使用基于时间的360度旋转
    let lastTime = performance.now();
    let frameCount = 0;

    function animate() {
      requestAnimationFrame(animate);

      const currentTime = performance.now();
      const deltaTime = (currentTime - lastTime) / 1000; // 转换为秒
      lastTime = currentTime;

      // 如果模型已加载且动画启用，让它自动360度旋转
      if (model && isAnimationEnabled && rotationSpeed > 0) {
        // 更新旋转角度（360度循环）
        rotationAngle += rotationSpeed * deltaTime;
        // 保持角度在0-360度范围内（可选，用于显示）
        if (rotationAngle >= 360) {
          rotationAngle -= 360;
        }
        // 转换为弧度并应用旋转（360度 = 2π 弧度）
        model.rotation.y = (rotationAngle * Math.PI) / 180;

        // 每60帧输出一次调试信息（约1秒一次）
        frameCount++;
        if (frameCount % 60 === 0) {
          console.log(
            "动画运行中 - 角度:",
            rotationAngle.toFixed(2),
            "度, 速度:",
            rotationSpeed,
            "度/秒"
          );
        }
      } else if (!model) {
        // 每60帧输出一次，提示模型未加载
        frameCount++;
        if (frameCount % 60 === 0) {
          console.log("等待模型加载...");
        }
      }

      controls.update(); // 更新控制器
      renderer.render(scene, camera);
    }
    animate();

    // 控制面板事件监听
    const animationToggle = document.getElementById("animationToggle");
    const speedSlider = document.getElementById("speedSlider");
    const speedValue = document.getElementById("speedValue");
    const zoomSlider = document.getElementById("zoomSlider");
    const zoomValue = document.getElementById("zoomValue");

    // 动画开关
    animationToggle.addEventListener("change", function (e) {
      isAnimationEnabled = e.target.checked;
      console.log("动画", isAnimationEnabled ? "开启" : "关闭");
    });

    // 速度滑块
    speedSlider.addEventListener("input", function (e) {
      rotationSpeed = parseFloat(e.target.value);
      speedValue.textContent = rotationSpeed.toFixed(1);
      console.log("旋转速度:", rotationSpeed, "度/秒");
    });

    // 缩放滑块
    zoomSlider.addEventListener("input", function (e) {
      zoomFactor = parseFloat(e.target.value);
      zoomValue.textContent = zoomFactor.toFixed(1);
      updateCameraPosition(); // 更新相机位置
      console.log("缩放因子:", zoomFactor);
    });

    // 初始化显示当前值
    speedValue.textContent = rotationSpeed.toFixed(1);
    zoomValue.textContent = zoomFactor.toFixed(1);
  </script>
</body>
</html>